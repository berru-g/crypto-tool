<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Crypto Globe - Version Stable</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden;
            background: #000;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial;
            padding: 20px;
            background: rgba(0,0,0,0.7);
            border-radius: 5px;
        }
        canvas { 
            display: block; 
            width: 100vw !important;
            height: 100vh !important;
        }
    </style>
</head>
<body>
    <div id="loading">Initialisation...</div>

    <script type="module">
        // CONFIGURATION DE BASE
        const init = async () => {
            const loadingElement = document.getElementById('loading');
            
            // 1. FORCER le redimensionnement initial
            const handleResize = () => {
                const width = window.innerWidth;
                const height = window.innerHeight;
                renderer.setSize(width, height, false);
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.render(scene, camera);
            };

            // 2. INIT Three.js avec vérification
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                powerPreference: "high-performance"
            });
            
            // 3. AJUSTEMENTS CRITIQUES
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);
            window.addEventListener('resize', handleResize);
            
            // 4. CHARGEMENT GARANTI
            try {
                // Terre
                const earthGeometry = new THREE.SphereGeometry(5, 64, 64);
                const earthTexture = await new THREE.TextureLoader().loadAsync(
                    'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/earth_atmos_2048.jpg'
                );
                const earth = new THREE.Mesh(
                    earthGeometry,
                    new THREE.MeshPhongMaterial({ map: earthTexture })
                );
                scene.add(earth);

                // Lumière
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(5, 3, 5);
                scene.add(light);
                scene.add(new THREE.AmbientLight(0x404040));

                // Test avec 1 arbre
                const loader = new THREE.GLTFLoader();
                const tree = await loader.loadAsync(
                    'https://raw.githubusercontent.com/berru-g/crypto-tool/main/headmap-forest/arbre1.glb'
                );
                tree.scene.position.set(5.1, 0, 0);
                tree.scene.scale.set(0.5, 0.5, 0.5);
                scene.add(tree.scene);

                // Contrôles
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                camera.position.z = 15;

                // Animation
                const animate = () => {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                };
                animate();

                // FORCER le premier rendu
                handleResize();
                loadingElement.style.display = 'none';

            } catch (error) {
                console.error("Erreur:", error);
                loadingElement.textContent = "Erreur de chargement - Voir console";
            }
        };

        // SOLUTION ULTIME : Vérifier que Three.js est prêt
        const checkThreeJS = () => {
            if (window.THREE) {
                init();
            } else {
                setTimeout(checkThreeJS, 100);
            }
        };

        // Chargement asynchrone garanti
        import('https://esm.sh/three').then(() => {
            import('https://esm.sh/three/examples/jsm/controls/OrbitControls').then(() => {
                import('https://esm.sh/three/examples/jsm/loaders/GLTFLoader').then(() => {
                    checkThreeJS();
                });
            });
        });
    </script>
</body>
</html>